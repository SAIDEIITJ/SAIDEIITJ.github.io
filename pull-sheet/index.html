---
layout: subdefault
title: Update faculty
---

<script type="text/javascript" src="papaparse.min.js"></script>
<script type="text/javascript" src="js-yaml.min.js"></script>
<script type="text/javascript" src="github.js"></script>

<h1>Update</h1>
<script type="text/javascript">

    var $resources = {
        team: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlkUKS3F0ObI73MPs3bprVyNBKN6RqINtipRkELpaTGrC2qMVvR6SyUgoAvSKPX1YHdfS3fyEF9Ni8/pub?output=tsv',
        news_events: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSYZExFU_O-a7QMx7bSMCOUsz8kjEErd3RVnlfIld1MYN40IpKoxYVuyxEesJvbimzKOKpVDE4FgbCC/pub?output=tsv',
        publications: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=2127468410&single=true&output=tsv',
        links: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=1206947112&single=true&output=tsv',
        faqs: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=1456991437&single=true&output=tsv',
        administration: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=728873275&single=true&output=tsv',
        students: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=1554989096&single=true&output=tsv',
        programs: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=668775554&single=true&output=tsv',
        events: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfOI9X3ROPtgANe0F_yYO70G2ITT3ymyrCtriG3IZXfBeHpkr7yuTY7eshCf_hasVu5LLDV50I-sJF/pub?gid=1893940642&single=true&output=tsv'
    };

    var header_maps = {
        // header mappings
        team: {
            "Acknowledgement": "acknowledgement",
            "Department / Center / School": "affiliation",
            "Faculity?": "faculty",
            "Subfaculty": "subfaculty",
            "Staff?": "staff",
            "Short bio 1": "bio1",
            "Short bio 2": "bio2",
            "Short bio 3": "bio3",
            "Short bio 4": "bio4",
            "Website": "website",
            "Office_number": "office_number",
            "Display?": "display",
            "email": "email",
            "Image": "image",
            "Name": "name",
            "phone": "phone",
            "Position": "position",
            "Timestamp": "timestamp",
            "Year of joining": "year",
            "Primary Affiliation": "primaryaffiliation"
        },
        news_events: {
            "Id": "id",
            "Title": "title",
            "Date": "date",
            "News?": "news",
            "Event?": "event",
            "Graphic": "graphic",
            "Content": "content",
            "Link": "link",
            "Visibility?": "visibility"
        },
        publications: {
            "Timestamp": "timestamp",
            "Journal": "journal",
            "Title": "title",
            "SAIDE Author 1": "author1",
            "Date": "date",
            "Link": "link",
            "Authors": "author",
            "Image": "image"
        },
        links: {
            "Page": "page",
            "Name": "name",
            "URL": "url"
        },
        faqs: {
            "Category": "category",
            "Question": "question",
            "Answer": "answer",
            "Visible": "visible"
        },
        administration: {
            "Position": "position",
            "Entry": "entry",
            "Link": "link"
        },
        students: {
            "Timestamp": "timestamp",
            "Name": "name",
            "Program": "program",
            "Specialization": "specialization",
            "Center": "center",
            "Email": "email",
            "ResearchArea": "researchArea",
            "Supervisor": "supervisor",
            "SecondSupervisor": "secondSupervisor",
            "HighestQualification": "highestQualification",
            "Website": "website",
            "ProfilePhoto": "profilePhoto",
            "Hidden": "hidden",
            "Alumnus": "alumnus"
        },
        programs: {
            "Timestamp": "timestamp",
            "Name": "name",
            "OfferedBy": "offered",
            "Level": "level",
            "Coordinator": "coordinator",
            "URL": "url",
            "Document": "document",
            "Background": "background",
            "Deadline": "deadline",
            "Application": "application"
        },
        events: {
            "Timestamp": "id",
            "Name": "name",
            "Start": "start",
            "End": "end",
            "Description": "description",
            "Type": "type",
            "Banner": "banner",
            "Preset": "preset",
            "TileBackground": "tileBackground",
            "Registration": "registration",
            "Schedule": "schedule",
            "Location": "location",
            "People": "people",
            "Sponsors": "sponsors",
            "Contact": "contact",
            "Hidden": "hidden"
        }
    };

    var $org = 'sw509073';
    var $repo = 'SAIDE_main';
    var $branch = 'main';
    
    function getUrlVar(key) {
        var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search);
        return result && unescape(result[1]) || "";
    }

    function getGDriveDlURL(url) {
        const regexp = /https:\/\/drive\.google\.com\/file\/d\/(?<id>[^/]+)\/view\?usp=sharing/;
        if (regexp.test(url)) {
            const res = regexp.exec(url);
            var id = res?.groups?.id;
            return `https://drive.google.com/thumbnail?id=${id.trim()}&sz=w300`;
        }
        return url;
    }

    function getGDriveOURL(url) {
        const regexp = /https:\/\/drive\.google\.com\/open\?id=(?<id>[^&]+)/;
        if (regexp.test(url)) {
            const res = regexp.exec(url);
            var id = res?.groups?.id;
            return `https://drive.google.com/thumbnail?id=${id.trim()}&sz=w300`;
        }
        return url;
    }

    var $GHToken = getUrlVar('ghtoken');
    var $yaml_store = "";

    function init() {
        var promises = $.map($resources, function(url, name) {
            return new Promise(function(resolve, reject) {
                Papa.parse(url, {
                    delimiter: "\t",
                    download: true,
                    skipEmptyLines: 'greedy',
                    dynamicTyping: 'true',
                    header: true,
                    transformHeader: function(header, index) { return header_maps[name][header]; },
                    transform: function(value, header) {
                        if (header == "image" || header == "graphic") return getGDriveDlURL(value);
                        if (header == "profilePhoto" || header == "background") return getGDriveOURL(value);
                        if (["display", "staff", "view", "faculty", "news", "event", "visibility", "hidden", "alumnus"].includes(header)) return parseInt(value);
                        return value;
                    },
                    complete: function(results) {
                        showInfo(results, name).then(resolve).catch(reject);
                    }
                });
            });
        });

        Promise.all(promises).then(function() {
            alert("All resources processed successfully!");
        }).catch(function(error) {
            console.error("Error processing resources:", error);
        });
    }

    window.addEventListener('DOMContentLoaded', init);

    function showInfo(results, $resource) {
        return new Promise(function(resolve, reject) {
            console.log($resource);
            console.log(results.data);
            console.log(results.errors);
            console.log(results.meta);

            if (results.data.length === 0) {
                console.warn("No data found for", $resource);
                return resolve();
            }

            alert("Successfully processed " + results.data.length + " rows for " + $resource + "!");

            var $items = results.data.map(function(service) {
                var $p = {};
                for (var $key in service) {
                    if (service.hasOwnProperty($key)) {
                        $p[$key] = service[$key];
                    }
                }
                return $p;
            });

            console.log($items);

            try {
                var $yaml_dump = jsyaml.dump($items);
                document.getElementById('source').value = $yaml_dump;

                var $writepath = '_data/' + $resource + '.yaml';

                fetch(`https://api.github.com/repos/${$org}/${$repo}/contents/${$writepath}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${$GHToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                })
                .then(response => {
                    if (response.status === 404) {
                        return writeFile();
                    }
                    return response.json();
                })
                .then(fileData => {
                    var latestSHA = fileData.sha;
                    writeFile(latestSHA);
                })
                .catch(err => {
                    console.error("Error reading from GitHub:", err);
                    reject(err);
                });

                function writeFile(latestSHA = null) {
                    var payload = {
                        message: 'Update ' + $resource,
                        content: btoa(unescape(encodeURIComponent($yaml_dump)))
                    };
                    if (latestSHA) {
                        payload.sha = latestSHA;
                    }

                    fetch(`https://api.github.com/repos/${$org}/${$repo}/contents/${$writepath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${$GHToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.commit) {
                            console.log("Successfully updated " + $resource);
                            resolve();
                        } else {
                            console.error("Error writing to GitHub:", data);
                            reject(data);
                        }
                    })
                    .catch(err => {
                        console.error("Error writing to GitHub:", err);
                        reject(err);
                    });
                }

            } catch (error) {
                console.error("Error dumping YAML:", error);
                reject(error);
            }
        });
    }
</script>
<textarea cols="10" rows="5" id="source" style="border: 1px solid #000; width: 100%; height: 500px;"></textarea>
